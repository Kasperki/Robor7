                        .module main.c
                        .area text(rom, con, rel)
 0000                   .dbfile ./main.c
                        .area data(ram, con, rel)
 0000                   .dbfile ./main.c
 0000           _timeT::
 0000                   .blkb 2
                        .area idata(rom,lit)
 0000 0000              .word 0
                        .area data(ram, con, rel)
 0002                   .dbfile ./main.c
 0002                   .dbfile Z:\Robo\Robor7\ROBOTT~1\ROBOTT~1\main.c
 0002                   .dbsym e timeT _timeT I
 0002           _timeT2::
 0002                   .blkb 2
                        .area idata(rom,lit)
 0002 0000              .word 0
                        .area data(ram, con, rel)
 0004                   .dbfile Z:\Robo\Robor7\ROBOTT~1\ROBOTT~1\main.c
 0004                   .dbsym e timeT2 _timeT2 I
 0004           _timeLCD::
 0004                   .blkb 2
                        .area idata(rom,lit)
 0004 0000              .word 0
                        .area data(ram, con, rel)
 0006                   .dbfile Z:\Robo\Robor7\ROBOTT~1\ROBOTT~1\main.c
 0006                   .dbsym e timeLCD _timeLCD I
 0006           _timeUltra::
 0006                   .blkb 2
                        .area idata(rom,lit)
 0006 0000              .word 0
                        .area data(ram, con, rel)
 0008                   .dbfile Z:\Robo\Robor7\ROBOTT~1\ROBOTT~1\main.c
 0008                   .dbsym e timeUltra _timeUltra I
 0008           _timeForward::
 0008                   .blkb 2
                        .area idata(rom,lit)
 0008 0032              .word 50
                        .area data(ram, con, rel)
 000A                   .dbfile Z:\Robo\Robor7\ROBOTT~1\ROBOTT~1\main.c
 000A                   .dbsym e timeForward _timeForward I
 000A           _turnTime::
 000A                   .blkb 2
                        .area idata(rom,lit)
 000A 003C              .word 60
                        .area data(ram, con, rel)
 000C                   .dbfile Z:\Robo\Robor7\ROBOTT~1\ROBOTT~1\main.c
 000C                   .dbsym e turnTime _turnTime I
 000C           _timeRobotWidth::
 000C                   .blkb 2
                        .area idata(rom,lit)
 000C 000F              .word 15
                        .area data(ram, con, rel)
 000E                   .dbfile Z:\Robo\Robor7\ROBOTT~1\ROBOTT~1\main.c
 000E                   .dbsym e timeRobotWidth _timeRobotWidth I
                        .area text(rom, con, rel)
 0000                   .dbfile Z:\Robo\Robor7\ROBOTT~1\ROBOTT~1\main.c
 0000                   .dbfunc e main _main fV
 0000           ;         buffer -> X+8
 0000           ;          kulma -> X+6
 0000           ;      ultraData -> X+4
 0000           ;           turn -> X+2
 0000           ;              i -> X+0
 0000           _main::
 0000                   .dbline -1
 0000 10                push X
 0001 4F                mov X,SP
 0002 3812              add SP,18
 0004                   .dbline 27
 0004           ; //----------------------------------------------------------------------------
 0004           ; // Robotti Projekti
 0004           ; // Robor7 @ 2014
 0004           ; // Kasper Kiiskinen, Henri Sinokki, Eero Holopainen, Mikko Liira, Kari Lampi
 0004           ; //----------------------------------------------------------------------------
 0004           ; 
 0004           ; #include <m8c.h>        // part specific constants and macros
 0004           ; #include "PSoCAPI.h"    // PSoC API definitions for all User Modules
 0004           ; #include<stdio.h>
 0004           ; #include<stdlib.h>
 0004           ; 
 0004           ; //Omat header filet
 0004           ; #include "MotorControl.h"
 0004           ; #include "UltraControl.h"
 0004           ; //#include "GyroControl.h"
 0004           ; 
 0004           ; //Kellot
 0004           ; int timeT = 0,timeT2 = 0;
 0004           ; int timeLCD = 0,timeUltra = 0; 
 0004           ; 
 0004           ; int timeForward = 50; //.... 4m täydellä vauhdilla 3.9s
 0004           ; int turnTime = 60;       //.... 90 asteen käännökseen meneväaika
 0004           ; int timeRobotWidth = 15; //.... Robotin leveyteen menevä aika ?
 0004           ; 
 0004           ; //Main Method
 0004           ; void main(void)
 0004           ; {
 0004                   .dbline 30
 0004           ;       //Määrittelyt
 0004           ;       char buffer[10];
 0004           ;       volatile int i = 0;
 0004 560100            mov [X+1],0
 0007 560000            mov [X+0],0
 000A                   .dbline 31
 000A           ;       int turn = 0;
 000A 560300            mov [X+3],0
 000D 560200            mov [X+2],0
 0010                   .dbline 32
 0010           ;       int ultraData = 0; //Data from ultrasonic sensor
 0010 560500            mov [X+5],0
 0013 560400            mov [X+4],0
 0016                   .dbline 33
 0016           ;       int kulma = 0;
 0016 560700            mov [X+7],0
 0019 560600            mov [X+6],0
 001C                   .dbline 38
 001C           ;       
 001C           ;       //Init**************************
 001C           ;       
 001C           ;       //Enables Global Interrupts
 001C           ;       M8C_EnableGInt; 
 001C 7101                      or  F, 01h
 001E           
 001E                   .dbline 41
 001E           ;               
 001E           ;       //Start LCD
 001E           ;       LCD_Start();
 001E 10                push X
 001F 7C0000            xcall _LCD_Start
 0022                   .dbline 44
 0022           ;       
 0022           ;       //InitializeTimer
 0022           ;       Timer8_Start();
 0022 7C0000            xcall _Timer8_Start
 0025                   .dbline 45
 0025           ;       Timer8_EnableInt();
 0025 7C0000            xcall _Timer8_EnableInt
 0028 20                pop X
 0029                   .dbline 48
 0029           ;               
 0029           ;       //Start Motor PWMs
 0029           ;       InitPWM();
 0029 7C0000            xcall _InitPWM
 002C                   .dbline 54
 002C           ;       
 002C           ;       //Init PGA and ADCIN for Ultrasonic
 002C           ;       //InitUA();
 002C           ;       
 002C           ;       //Testink
 002C           ;       TestLoop();
 002C 901A              xcall _TestLoop
 002E                   .dbline -2
 002E           L1:
 002E 38EE              add SP,-18
 0030 20                pop X
 0031                   .dbline 0 ; func end
 0031 8FFF              jmp .
 0033                   .dbsym l buffer 8 A[10:10]c
 0033                   .dbsym l kulma 6 I
 0033                   .dbsym l ultraData 4 I
 0033                   .dbsym l turn 2 I
 0033                   .dbsym l i 0 I
 0033                   .dbend
 0033                   .dbfunc e TimerInterrupt _TimerInterrupt fV
 0033           _TimerInterrupt::
 0033                   .dbline -1
 0033                   .dbline 179
 0033           ;       
 0033           ;       //MainLoop**********
 0033           ;       //***********************
 0033           ;       /*while(1)
 0033           ;       {
 0033           ;               //Controlls the ultraSonic trigger
 0033           ;               //ControlTrigger(&timeUltra);   
 0033           ;                       
 0033           ;               //Gets the data
 0033           ;               //ultraData = getDataUA();
 0033           ;               
 0033           ;               //Spiraali
 0033           ;               if(i < 10)
 0033           ;               {
 0033           ;                       if(i < 3)
 0033           ;                       {
 0033           ;                               if(turn == 0)
 0033           ;                                       MoveForward(HALF_SPEED);
 0033           ;                               else 
 0033           ;                               {
 0033           ;                                       if(timeT <= turnTime) //if(gyroKulma < 90)
 0033           ;                                       {
 0033           ;                                               TurnLeft(HALF_SPEED);
 0033           ;                                       }
 0033           ;                                       else
 0033           ;                                       { 
 0033           ;                                               turn = 0;
 0033           ;                                               timeT = 0;
 0033           ;                                       }
 0033           ;                               }
 0033           ;                       }
 0033           ;                       else if(i < 5) 
 0033           ;                       {
 0033           ;                               i = 0;
 0033           ;                               timeForward -= timeRobotWidth;
 0033           ;                       }
 0033           ;                       
 0033           ;                       //Kokokierros on menty
 0033           ;                       if(timeForward <= 0)
 0033           ;                       {
 0033           ;                               i = 10;
 0033           ;                               timeT = 0; 
 0033           ;                               timeT2 = 0;
 0033           ;                               turn = 0;
 0033           ;                               timeForward = 0;
 0033           ;                               Stop();
 0033           ;                       }
 0033           ;                       else if (timeT >= timeForward && turn == 0)
 0033           ;                       {
 0033           ;                               i++;
 0033           ;                               turn = 1;
 0033           ;                               timeT = 0;
 0033           ;                       }
 0033           ;               }
 0033           ;               //End Spiraali
 0033           ;               
 0033           ;               
 0033           ;               //Scan
 0033           ;               if(i == 100)
 0033           ;               {
 0033           ;                       if(kulma < 360)
 0033           ;                       {
 0033           ;                               if(ultraData < 200)
 0033           ;                               {       
 0033           ;                                       if(ultraData > 0)
 0033           ;                                               MoveForward(SLOW_SPEED); 
 0033           ;                               }
 0033           ;                               else if (timeT2 >= 50) //WAIT 500ms
 0033           ;                               {
 0033           ;                                       if (turn == 0)
 0033           ;                                       {       
 0033           ;                                               timeT = 0;
 0033           ;                                               turn = 1;
 0033           ;                                       }
 0033           ;                                               
 0033           ;                                       if(timeT <= 20)
 0033           ;                                               TurnRight(HALF_SPEED);
 0033           ;                                       else
 0033           ;                                       {
 0033           ;                                               kulma+=5;
 0033           ;                                               timeT2 = 0;
 0033           ;                                               turn = 0;
 0033           ;                                       }
 0033           ;                               }
 0033           ;                               else 
 0033           ;                                       Stop();
 0033           ;                       }
 0033           ;                       else 
 0033           ;                               i = 20;
 0033           ;               }
 0033           ;               
 0033           ;               if(i == 20)
 0033           ;                       Stop();
 0033           ;               
 0033           ;               
 0033           ;               //WRITE TO LCD
 0033           ;               if(timeLCD >= 6)
 0033           ;               {
 0033           ;                       itoa(buffer,ultraData,10);
 0033           ;                       LCD_Position(0,0);
 0033           ;                       LCD_PrCString("      ");
 0033           ;                       LCD_Position(0,0);
 0033           ;                       LCD_PrString(buffer);
 0033           ;                                       
 0033           ;                       //
 0033           ;                       LCD_Position(0,5);
 0033           ;                       LCD_PrCString("      ");
 0033           ;                       itoa(buffer,timeForward,10);
 0033           ;                       LCD_Position(0,5);
 0033           ;                       LCD_PrString(buffer);
 0033           ;                       
 0033           ;                       LCD_Position(1,0);
 0033           ;                       LCD_PrCString("      ");
 0033           ;                       itoa(buffer,kulma,10);
 0033           ;                       LCD_Position(1,0);
 0033           ;                       LCD_PrString(buffer);
 0033           ;                       
 0033           ;                       timeLCD = 0;
 0033           ;               }               
 0033           ;       }*/
 0033           ; }
 0033           ; 
 0033           ; //Kutsutaan joka 0.01s = 10ms välein.
 0033           ; void TimerInterrupt()
 0033           ; {
 0033                   .dbline 180
 0033           ;   timeT++;
 0033 7601              inc [_timeT+1]
 0035 0E0000            adc [_timeT],0
 0038                   .dbline 181
 0038           ;   timeT2++;
 0038 7603              inc [_timeT2+1]
 003A 0E0200            adc [_timeT2],0
 003D                   .dbline 183
 003D           ; 
 003D           ;   timeLCD++; //Controlls LCD draw cycle
 003D 7605              inc [_timeLCD+1]
 003F 0E0400            adc [_timeLCD],0
 0042                   .dbline 184
 0042           ;   timeUltra++; //Controlls Ultrasonic sensor trigger time
 0042 7607              inc [_timeUltra+1]
 0044 0E0600            adc [_timeUltra],0
 0047                   .dbline -2
 0047           L2:
 0047                   .dbline 0 ; func end
 0047 7F                ret
 0048                   .dbend
 0048                   .dbfunc e TestLoop _TestLoop fV
 0048           _TestLoop::
 0048                   .dbline -1
 0048                   .dbline 189
 0048           ; }
 0048           ; 
 0048           ; //For Testing
 0048           ; void TestLoop()
 0048           ; {
 0048 8030              xjmp L5
 004A           L4:
 004A                   .dbline 191
 004A           ;       while(1)
 004A           ;       {
 004A                   .dbline 193
 004A           ;               
 004A           ;               LCD_Position(1,0);
 004A 10                push X
 004B 5700              mov X,0
 004D 5001              mov A,1
 004F 7C0000            xcall _LCD_Position
 0052                   .dbline 194
 0052           ;               LCD_PrCString("PIRI TOIMII");
 0052 5000              mov A,>L7
 0054 08                push A
 0055 5000              mov A,<L7
 0057 5C                mov X,A
 0058 18                pop A
 0059 7C0000            xcall _LCD_PrCString
 005C 20                pop X
 005D                   .dbline 206
 005D           ;               
 005D           ;               //Test 4m
 005D           ;               /*
 005D           ;               if (timeT < 250)
 005D           ;                       TurnLeft(FULL_SPEED);
 005D           ;               else if (timeT < 500)
 005D           ;                       TurnRight(HALF_SPEED);
 005D           ;               else 
 005D           ;                       Stop();
 005D           ;               */
 005D           ;               
 005D           ;               if (timeT < 400)
 005D 5101              mov A,[_timeT+1]
 005F 1190              sub A,-112
 0061 5100              mov A,[_timeT]
 0063 3180              xor A,-128
 0065 1981              sbb A,(1 ^ 0x80)
 0067 D00E              jnc L8
 0069           X1:
 0069                   .dbline 207
 0069           ;                       MoveForward(FULL_SPEED);
 0069 5000              mov A,0
 006B 08                push A
 006C 50C7              mov A,-57
 006E 08                push A
 006F 7C0000            xcall _MoveForward
 0072 38FE              add SP,-2
 0074 8004              xjmp L9
 0076           L8:
 0076                   .dbline 209
 0076           ;               else
 0076           ;                       Stop();
 0076 7C0000            xcall _Stop
 0079           L9:
 0079                   .dbline 219
 0079           ;                       
 0079           ;               //Test 90 degree Turn
 0079           ;               /*      
 0079           ;                       if(timeT <= 100) //1.0s
 0079           ;                               TurnRight(FULL_SPEED);
 0079           ;                       else if(timeT <= 400)
 0079           ;                               timeT = 0;
 0079           ;               */
 0079           ;               
 0079           ;       }
 0079           L5:
 0079                   .dbline 190
 0079 8FD0              xjmp L4
 007B           X0:
 007B                   .dbline -2
 007B           L3:
 007B                   .dbline 0 ; func end
 007B 7F                ret
 007C                   .dbend
                        .area lit(rom, con, rel, lit)
 0000           L7:
 0000 5049524920544F494D494900  .byte 'P,'I,'R,'I,32,'T,'O,'I,'M,'I,'I,0
